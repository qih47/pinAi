import fitz  # PyMuPDF
import warnings
import time
from pathlib import Path
import json
import torch
import numpy as np
import os
import gc
from PIL import Image, ImageEnhance, ImageFilter

# FORCE CPU UNTUK PADDLEOCR - MENCEGAH SEGMENTATION FAULT
warnings.filterwarnings('ignore')

class PDFExtractor:
    def __init__(self):
        """
        Initialize PDF extractor with PaddleOCR (CPU Only)
        """
        self.paddleocr_reader = None
        self.init_paddleocr()

    def init_paddleocr(self):
        """Initialize PaddleOCR in CPU mode"""
        print("üîÑ Initializing PaddleOCR (CPU Mode)...")
        try:
            os.environ['CUDA_VISIBLE_DEVICES'] = '-1'  # force CPU
            from paddleocr import PaddleOCR

            self.paddleocr_reader = PaddleOCR(
                use_angle_cls=True,
                lang='id',
                use_gpu=False,
                show_log=False,
                det_db_thresh=0.3,
                drop_score=0.5
            )
            print("‚úÖ PaddleOCR initialized successfully (CPU Mode)")
        except ImportError:
            print("‚ùå PaddleOCR not installed. Install with: pip install paddleocr paddlepaddle")
            self.paddleocr_reader = None
        except Exception as e:
            print(f"‚ùå PaddleOCR initialization failed: {e}")
            self.paddleocr_reader = None

    def _enhance_image_quality(self, img_array):
        """Enhance image quality for better OCR results"""
        try:
            # Convert numpy array to PIL Image
            if len(img_array.shape) == 2:
                img_pil = Image.fromarray(img_array, mode='L')  # Grayscale
            else:
                img_pil = Image.fromarray(img_array, mode='RGB')
            
            # 1. Convert to grayscale (OCR works better on grayscale)
            if img_pil.mode != 'L':
                img_pil = img_pil.convert('L')
            
            # 2. Enhance contrast
            enhancer = ImageEnhance.Contrast(img_pil)
            img_pil = enhancer.enhance(1.5)  # Increase contrast 1.5x
            
            # 3. Enhance sharpness
            enhancer = ImageEnhance.Sharpness(img_pil)
            img_pil = enhancer.enhance(1.3)  # Increase sharpness
            
            # 4. Apply slight denoising
            img_pil = img_pil.filter(ImageFilter.MedianFilter(size=1))
            
            # 5. Adaptive thresholding (binarization)
            img_array = np.array(img_pil)
            
            # Simple adaptive threshold
            mean_val = np.mean(img_array)
            img_array = np.where(img_array > mean_val * 0.8, 255, 0).astype(np.uint8)
            
            return img_array
            
        except Exception as e:
            print(f"   ‚ö†Ô∏è Image enhancement failed: {e}")
            return img_array

    def extract_with_paddleocr_enhanced(self, pdf_path: str) -> dict:
        """Extract text from PDF with enhanced image preprocessing"""
        if not self.paddleocr_reader:
            return {"error": "PaddleOCR not initialized", "success": False}

        try:
            doc = fitz.open(pdf_path)
            total_pages = doc.page_count
            results = {}
            total_time = 0

            print(f"Processing {total_pages} pages with ENHANCED preprocessing...")
            print("   Steps: 1. High DPI (600) ‚Üí 2. Grayscale ‚Üí 3. Contrast enhancement")
            print("          4. Sharpness ‚Üí 5. Denoising ‚Üí 6. Binarization")
            
            for page_num in range(total_pages):
                start_time = time.time()
                page = doc.load_page(page_num)

                # OPTIMAL DPI: 600 (balance antara kualitas dan memory)
                # 300-600 DPI optimal untuk OCR, 1200 terlalu besar
                dpi = 600
                mat = fitz.Matrix(dpi/72, dpi/72)
                
                # Render dengan DPI optimal
                pix = page.get_pixmap(matrix=mat, alpha=False)

                # Convert to numpy
                img_array = np.frombuffer(pix.samples, dtype=np.uint8)
                img_array = img_array.reshape(pix.height, pix.width, pix.n)
                
                if pix.n == 4:
                    img_array = img_array[:, :, :3]

                # ENHANCE IMAGE QUALITY SEBELUM OCR
                print(f"   Page {page_num + 1}: Enhancing image quality...")
                img_array = self._enhance_image_quality(img_array)

                # OCR
                try:
                    ocr_result = self.paddleocr_reader.ocr(img_array, cls=False)
                except Exception as ocr_error:
                    print(f"   ‚ùå OCR failed: {ocr_error}")
                    ocr_result = None

                # Process results
                page_text_lines = []
                if ocr_result:
                    for line in ocr_result:
                        if line:
                            for item in line:
                                if item and len(item) >= 2:
                                    text_info = item[1]
                                    if text_info:
                                        text = str(text_info[0]).strip()
                                        if text:
                                            page_text_lines.append(text)

                page_text = "\n".join(page_text_lines)
                page_time = time.time() - start_time
                total_time += page_time

                results[page_num + 1] = {
                    "text": page_text,
                    "char_count": len(page_text),
                    "word_count": len(page_text.split()),
                    "line_count": len(page_text_lines),
                    "processing_time": round(page_time, 2),
                    "dpi_used": dpi,
                    "enhancement": "Yes"
                }

                print(f"   Page {page_num + 1}: {len(page_text_lines)} lines, "
                      f"{len(page_text)} chars, {page_time:.1f}s")

                # Cleanup
                del img_array, pix
                gc.collect()

            doc.close()
            total_chars = sum(p["char_count"] for p in results.values())

            return {
                "success": True,
                "total_pages": total_pages,
                "total_processing_time": round(total_time, 2),
                "total_characters": total_chars,
                "pages": results,
                "method": "PaddleOCR-Enhanced",
                "config": {
                    "dpi": 600,
                    "preprocessing": True,
                    "enhancement_steps": [
                        "grayscale",
                        "contrast_enhancement",
                        "sharpness",
                        "denoising",
                        "binarization"
                    ]
                }
            }

        except Exception as e:
            print(f"‚ùå PaddleOCR extraction failed: {e}")
            return {"error": str(e), "success": False}

    def save_results(self, results: dict, output_dir: str = "./outputs") -> dict:
        """Save PaddleOCR results to files"""
        Path(output_dir).mkdir(exist_ok=True, parents=True)
        filename = results.get("metadata", {}).get("filename", "output").replace(".pdf", "")
        timestamp = int(time.time())
        saved_files = {}

        if results.get("paddleocr", {}).get("success"):
            paddleocr_text = ""
            for page_num, page_data in results["paddleocr"]["pages"].items():
                paddleocr_text += f"\n{'='*60}\n"
                paddleocr_text += f"PAGE {page_num}\n"
                paddleocr_text += f"{'='*60}\n\n"
                paddleocr_text += page_data["text"]
                paddleocr_text += f"\n\n[Chars: {page_data.get('char_count', 0)} | "
                paddleocr_text += f"Words: {page_data.get('word_count', 0)} | "
                paddleocr_text += f"Lines: {page_data.get('line_count', 0)} | "
                paddleocr_text += f"Time: {page_data.get('processing_time', 0)}s | "
                paddleocr_text += f"DPI: {page_data.get('dpi_used', 0)} | "
                paddleocr_text += f"Enhanced: {page_data.get('enhancement', 'No')}]\n"

            paddleocr_file = Path(output_dir) / f"{filename}_paddleocr_{timestamp}.txt"
            with open(paddleocr_file, "w", encoding="utf-8") as f:
                f.write(paddleocr_text)
            print(f"üìÑ PaddleOCR text saved: {paddleocr_file}")
            saved_files["paddleocr"] = str(paddleocr_file)

        json_file = Path(output_dir) / f"{filename}_results_{timestamp}.json"
        with open(json_file, "w", encoding="utf-8") as f:
            json.dump(results, f, indent=2, ensure_ascii=False)
        print(f"üìä JSON results saved: {json_file}")
        saved_files["json"] = str(json_file)

        return saved_files


def main():
    pdf_path = "./outputs/upload_SE_Seragam_1765261228_enhanced.pdf"
    if not Path(pdf_path).exists():
        print(f"‚ùå File not found: {pdf_path}")
        return

    print(f"üìÑ Processing PDF: {pdf_path}")
    print(f"üîç Using ENHANCED preprocessing for better OCR accuracy")
    extractor = PDFExtractor()

    start_time = time.time()
    results = {
        "paddleocr": extractor.extract_with_paddleocr_enhanced(pdf_path),
        "metadata": {"filename": Path(pdf_path).name,
                     "extraction_time": time.strftime("%Y-%m-%d %H:%M:%S")}
    }
    total_time = time.time() - start_time
    print(f"\n‚è±Ô∏è Total extraction time: {total_time:.1f}s")

    if results["paddleocr"].get("success"):
        extractor.save_results(results)
        print(f"\n‚úÖ PDF OCR extraction complete with enhanced preprocessing!")


if __name__ == "__main__":
    print("="*70)
    print("PDF OCR EXTRACTION TOOL - ENHANCED PREPROCESSING")
    print("Method: High DPI + Image Enhancement for better accuracy")
    print("="*70)
    main()
