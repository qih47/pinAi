<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <title>üìÑ Upload Dokumen - AI Data System</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <!-- SweetAlert2 -->
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <style>
    body { background-color: #f8f9fa; }
    .card { border-radius: 12px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
    #logBox { font-family: monospace; height: 250px; overflow-y: auto; display: none; }
  </style>
</head>
<body>
  <div class="container mt-5">
    <div class="card p-4">
      <h3 class="text-center mb-4">üß† Pindad AI Data Learning Management System</h3>
  
      <div class="row">
        <!-- KIRI: Form input -->
        <div class="col-md-7">
          <form id="uploadForm">
            <div class="row mb-3">
              <div class="col-md-12">
                <label class="form-label fw-bold">üìÑ Pilih Dokumen (PDF)</label>
                <input class="form-control" type="file" id="file" name="file" accept=".pdf" required>
              </div>
            </div>
  
            <div class="row mb-3">
              <div class="col-md-12">
                <label class="form-label fw-bold">üìÅ Nama File</label>
                <input type="text" id="nama_file" name="nama_file" class="form-control" placeholder="otomatis terisi saat pilih file" required readonly>
              </div>
            </div>
  
            <div class="row mb-3">
              <div class="col-md-6">
                <label class="form-label fw-bold">üìù Judul Dokumen</label>
                <input type="text" name="judul_dokumen" class="form-control" placeholder="contoh: Prosedur Pengujian Produk" required>
              </div>
              <div class="col-md-6">
                <label class="form-label fw-bold">üî¢ Nomor Dokumen</label>
                <input type="text" name="nomor_dokumen" class="form-control" placeholder="contoh: PR-001-2025" required>
              </div>
            </div>
  
            <div class="row mb-3">
              <div class="col-md-4">
                <label class="form-label fw-bold">üè∑Ô∏è Jenis Dokumen</label>
                <select name="jenis_dokumen" class="form-select" required>
                  <option value="">-- Pilih Jenis --</option>
                  {% for jd in jenis_dokumen %}
                    <option value="{{ jd.id }}">{{ jd.nama }}</option>
                  {% endfor %}
                </select>
              </div>
              <div class="col-md-4">
                <label class="form-label fw-bold">üìÖ Tanggal Dokumen</label>
                <input type="date" name="tanggal_dokumen" class="form-control" required>
              </div>
              <div class="col-md-4">
                <label class="form-label fw-bold">üìç Tempat Dokumen</label>
                <input type="text" name="tempat_dokumen" class="form-control" placeholder="contoh: Bandung" required>
              </div>
            </div>
            <input type="hidden" id="hidden_ocr_text" name="ocr_text" />
            <div class="row mb-3">
              <div class="col-6 pe-1">
                <button class="btn btn-primary w-100" type="button" id="btnProsesDoc">
                  üöÄ Proses Document
                </button>
              </div>
              <div class="col-6 ps-1">
                <button class="btn btn-primary w-100" type="submit" id="btnSubmit" disabled>
                  üöÄ Proses Pharsing
                </button>
              </div>
            </div>
          </form>
        </div>
  
        <!-- KANAN: Log Box -->
        <div class="col-md-5">
          <div id="logBox" class="p-3 bg-dark text-light rounded" style="height: 600px; overflow-y: auto;">
            <b>ü™Ñ Log Proses:</b><br>üìÑ Siap untuk mengunggah dokumen...<br>
          </div>
        </div>
        <div class="col-md-12 mt-2">
          <button id="btnSaveEdit" class="btn btn-success" style="display:none;">üíæ Simpan Perubahan</button>
        </div>
        <div class="row mt-4">
          <div class="col-md-12">
            <label class="form-label fw-bold">üìÑ Hasil OCR (Teks Mentah)</label>
            <textarea id="ocrResult" class="form-control" rows="150" style="font-family: monospace;"></textarea>
          </div>
        </div>
      </div>
  </div>
</div>
</body>
</html>
<script>
  document.addEventListener("DOMContentLoaded", () => {
      const logBox = document.getElementById("logBox");
      const btnSubmit = document.getElementById("btnSubmit");
      const btnProsesDoc = document.getElementById("btnProsesDoc");
      const btnSaveEdit = document.getElementById("btnSaveEdit"); // ‚Üê tambahkan ini
      const fileInput = document.getElementById("file");
      const namaFileInput = document.getElementById("nama_file");
      const ocrResult = document.getElementById("ocrResult");
  
      // Field lain untuk validasi
      const formFields = [
          document.querySelector('input[name="judul_dokumen"]'),
          document.querySelector('input[name="nomor_dokumen"]'),
          document.querySelector('select[name="jenis_dokumen"]'),
          document.querySelector('input[name="tanggal_dokumen"]'),
          document.querySelector('input[name="tempat_dokumen"]')
      ];
  
      // Init logBox
      logBox.style.display = "block";
      logBox.innerHTML = "<b>ü™Ñ Log Proses:</b><br>üìÑ Siap untuk mengunggah dokumen...<br>";
  
      if (namaFileInput.value) {
          logBox.innerHTML += `üìÑ ${namaFileInput.value} telah diunggah.<br>`;
          btnProsesDoc.disabled = false;
      }
  
      fileInput.addEventListener("change", () => {
          namaFileInput.value = fileInput.files[0]?.name || "";
          if (namaFileInput.value) {
              logBox.innerHTML += `üìÑ ${namaFileInput.value} siap untuk di proses.<br>`;
              btnProsesDoc.disabled = false;
          } else {
              btnProsesDoc.disabled = true;
          }
      });
  
      function checkFields() {
          const allFilled = formFields.every(f => f?.value.trim() !== "");
          btnSubmit.disabled = !allFilled;
      }
      formFields.forEach(f => f?.addEventListener("input", checkFields));
      checkFields();
  
      // Simpan referensi teks asli
      let originalText = "";

      // --- PROSES DOKUMEN ---
      btnProsesDoc.addEventListener("click", async () => {
          const file = fileInput.files[0];
          if (!file) {
              logBox.innerHTML += "‚ùå Tidak ada file yang dipilih.<br>";
              return;
          }
  
          logBox.innerHTML += `üöÄ Memulai proses dokumen: ${file.name}...<br>`;
          logBox.scrollTop = logBox.scrollHeight;
  
          const formData = new FormData();
          formData.append("file", file);
  
          try {
              logBox.innerHTML += "‚úÇÔ∏è Memotong margin dokumen pdf....<br>";
              const cropRes = await fetch("/proses_crop", { method: "POST", body: formData }).then(r => r.json());
              if (cropRes.log) logBox.innerHTML += "‚úÇÔ∏è Log Crop:<br>" + cropRes.log.replace(/\n/g, "<br>") + "<br>";
              logBox.innerHTML += "‚úÖ Pemotongan selesai dilakukan....<br>";
              logBox.scrollTop = logBox.scrollHeight;
  
              logBox.innerHTML += "üöÄ Memulai proses OCR dokumen PDF.....<br>";
              const ocrRes = await fetch("/proses_ocr", { method: "POST" }).then(r => r.json());
              if (ocrRes.log) logBox.innerHTML += "üîç Log OCR:<br>" + ocrRes.log.replace(/\n/g, "<br>") + "<br>";
              logBox.innerHTML += "üéâ OCR selesai dilakukan....<br>";
              logBox.scrollTop = logBox.scrollHeight;
  
              logBox.innerHTML += "üì• Mengambil hasil OCR terbaru...<br>";
              const textRes = await fetch("/get_latest_ocr_text");
              const textData = await textRes.json();
  
              if (textRes.ok) {
                ocrResult.value = textData.content;
                originalText = textData.content;
                btnSaveEdit.style.display = "none";
                logBox.innerHTML += `‚úÖ Berhasil menampilkan isi file: ${textData.filename}<br>`;
            } else {
                  logBox.innerHTML += `‚ùå Gagal muat teks OCR: ${textData.error}<br>`;
              }
              logBox.innerHTML += "‚úÖ Semua proses telah berhasil dilakukan....<br>";
              logBox.scrollTop = logBox.scrollHeight;
          } catch (err) {
              logBox.innerHTML += `‚ùå Error: ${err.message || err}<br>`;
              logBox.scrollTop = logBox.scrollHeight;
          }
      });
  
      ocrResult.addEventListener("input", () => {
          const isChanged = ocrResult.value !== originalText;
          btnSaveEdit.style.display = isChanged ? "inline-block" : "none";
      });

      // --- SIMPAN EDIT ---
      if (btnSaveEdit) {
        btnSaveEdit.addEventListener("click", async () => {
            const editedText = ocrResult?.value || "";
            if (!editedText.trim()) {
                Swal.fire({
                    icon: "warning",
                    title: "Teks Kosong",
                    text: "Tidak ada perubahan untuk disimpan.",
                    confirmButtonText: "OK"
                });
                return;
            }
    
            try {
                const res = await fetch("/save_edited_ocr", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ content: editedText })
                });
    
                if (res.ok) {
                    originalText = editedText;
                    btnSaveEdit.style.display = "none";
                    Swal.fire({
                        icon: "success",
                        title: "Berhasil Disimpan!",
                        text: "Perubahan telah disimpan ke file.",
                        confirmButtonText: "OK"
                    });
                } else {
                    const err = await res.json();
                    throw new Error(err.error || "Gagal menyimpan");
                }
            } catch (e) {
                Swal.fire({
                    icon: "error",
                    title: "Gagal Menyimpan",
                    text: e.message || "Terjadi kesalahan saat menyimpan.",
                    confirmButtonText: "Coba Lagi"
                });
                // Opsional: juga tampilkan di logBox untuk debugging
                logBox.innerHTML += `‚ùå Error simpan: ${e.message}<br>`;
                logBox.scrollTop = logBox.scrollHeight;
            }
        });
    }
  
      // --- SUBMIT FORM (dengan debug metadata) ---
      const form = document.getElementById("uploadForm");
      form?.addEventListener("submit", async (e) => {
          e.preventDefault();
          const ocrText = ocrResult.value.trim();
          const jenisDokumen = document.querySelector('select[name="jenis_dokumen"]').value;

          let debugEndpoint = "";
          if (jenisDokumen === "1") debugEndpoint = "/chunk_skep";
          else if (jenisDokumen === "2") debugEndpoint = "/chunk_se";
          else if (jenisDokumen === "3") debugEndpoint = "/chunk_ik";
          else if (jenisDokumen === "4") debugEndpoint = "/chunk_prosedur";
          else {
              logBox.innerHTML += "‚ùå Jenis dokumen tidak valid.<br>";
              return;
          }

          try {
              const res = await fetch(debugEndpoint, {
                  method: "POST",
                  headers: { "Content-Type": "application/json" },
                  body: JSON.stringify({ text: ocrText })
              });
              const data = await res.json();

              if (res.ok) {
                  logBox.innerHTML += `‚úÖ ${data.doc_type} terdeteksi (${data.chunk_count} chunk)<br>`;
                  data.preview_chunks.forEach(chunk => {
                      const parent = chunk.parent_title ? ` (parent: ${chunk.parent_title})` : "";
                      logBox.innerHTML += `üß© <b>${chunk.title}</b>${parent}<br>`;
                  });
              } else {
                  logBox.innerHTML += `‚ö†Ô∏è Error: ${data.error}<br>`;
              }
          } catch (err) {
              logBox.innerHTML += `‚ö†Ô∏è Error koneksi: ${err.message}<br>`;
          }

          // --- Kirim ke /upload seperti biasa ---
          document.getElementById("hidden_ocr_text").value = ocrText;
          const formData = new FormData(form);

          logBox.innerHTML += "üöÄ Mengunggah dokumen dan memulai proses parsing...<br>";
          btnSubmit.disabled = true;
          btnSubmit.innerText = "‚è≥ Sedang diproses...";
          logBox.scrollTop = logBox.scrollHeight;

          fetch("/upload", {
              method: "POST",
              body: formData
          })
          .then(res => res.json())
          .then(data => {
              if (data.status === "success") {
                  Swal.fire("Berhasil!", "Dokumen berhasil disimpan ke database.", "success");
                  logBox.innerHTML += "‚úÖ Dokumen tersimpan di database.<br>";
              } else {
                  Swal.fire("Gagal", data.error || "Gagal simpan dokumen.", "error");
                  logBox.innerHTML += `‚ùå Gagal simpan: ${data.error}<br>`;
              }
              btnSubmit.disabled = false;
              btnSubmit.innerText = "üöÄ Proses Pharsing";
              logBox.scrollTop = logBox.scrollHeight;
          })
          .catch(err => {
              Swal.fire("Error", "Koneksi gagal.", "error");
              logBox.innerHTML += `‚ùå Error: ${err.message}<br>`;
              btnSubmit.disabled = false;
              btnSubmit.innerText = "üöÄ Proses Pharsing";
              logBox.scrollTop = logBox.scrollHeight;
          });
      });
  });
  </script>
  